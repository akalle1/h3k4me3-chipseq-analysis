import pandas as pd
configfile: "../../config/config.yaml"
samples_df = pd.read_csv("../../config/samples.tsv", sep="\t")
SAMPLES = samples_df["sample"].tolist()
TREATMENT = samples_df[samples_df["condition"] == "chip"]["sample"].tolist()
REFERENCE = "../../data/reference/hg38_chr22.fa"
 
rule all:
    input:
        expand("results/aligned/{sample}.sorted.bam", sample=SAMPLES),
        expand("results/aligned/{sample}.sorted.bam.bai", sample=SAMPLES),
        expand("results/qc/fastqc/{sample}_fastqc.html", sample=SAMPLES),
        "results/qc/multiqc/multiqc_report.html"
        expand("results/peaks/{sample}_peaks.narrowPeak", sample=TREATMENTS)

rule fastqc:
    input:
        "../../data/raw/{sample}.fastq.gz"
    output:
        html="results/qc/fastqc/{sample}_fastqc.html",
        zip="results/qc/fastqc/{sample}_fastqc.zip"
    threads: 2
    shell:
        "fastqc {input} -o results/qc/fastqc/ -t {threads}"

rule bwa_align:
    input:
        fq = "../../data/raw/{sample}.fastq.gz",
	ref=REFERENCE
    output:
        temp("results/aligned/{sample}.sam")
    threads: 4
    log:
	"log/bwa/{sample}.log"
    shell:
        "bwa mem -t {threads} {input.ref} {input.fq} > {output} 2> {log}"

rule sam_to_bam:
    input:
	"results/aligned/{sample}.sam"
    output:
	"results/aligned/{sample}.sorted.bam"
    threads: 4
    shell:
        "samtools sort -@ -threads -o {output} {input}"
#bam file is already sorted

rule index_bam:
    input:
        "results/aligned/{sample}.sorted.bam"
    output:
        "results/aligned/{sample}.sorted.bam.bai"
    shell:
        "samtools index {input}"

rule call_peaks:
    input:
       	treatment="results/aligned/{sample}.sorted.bam",        
	control="results/aligned/control.sorted.bam"
    output:
        narrowpeak="results/peaks/{sample}_peaks.narrowPeak",
        xls="results/peaks/{sample}_peaks.xls",
	summits="results/peaks/{sample}_summits.bed"
    params:
        name="{sample}",
        outdir="results/peaks"
    log:
        "logs/macs/{sample}.log"
    shell:
       "mkdir -p {params.outdir} && macs3 callpeak -t {input.treatment} -c {input.control} -f BAM -g hs -n {params.name} --outdir {params.outdir} -q 0.05 2> {log}"    

rule multiqc:
    input:
        expand("results/qc/fastqc/{sample}_fastqc.zip", sample=SAMPLES)
    output:
        "results/qc/multiqc/multiqc_report.html"
    params:
        outdir="results/qc/multiqc"
    shell:
        "mkdir -p {params.outdir} && multiqc -o {params.outdir} results/qc/fastqc/"
